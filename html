<!-- static/editor.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Éditeur d'Irrigation</title>
  <!-- Feuilles de style Leaflet et Leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    #map { width: 100%; height: 600px; }
    .controls { margin: 10px; }
  </style>
</head>
<body>
  <div class="controls">
    <!-- L'adresse sera en fait fournie par Bubble. Ici, on peut la préremplir ou la laisser éditable -->
    <input type="text" id="addressInput" placeholder="Adresse (fournie par Bubble)" size="50">
    <button id="geocodeBtn">Géocoder</button>
    <br>
    <label for="pressionInput">Pression (bars) :</label>
    <input type="number" id="pressionInput" step="0.1" value="3.0">
    <button id="submitBtn">Générer Plan</button>
  </div>
  <div id="map"></div>

  <!-- Scripts Leaflet et Leaflet Draw -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    // Initialisation de la carte centrée par défaut (exemple sur Paris)
    var map = L.map('map').setView([48.8566, 2.3522], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // Calque pour les dessins
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Contrôle de dessin (polygones et marker)
    var drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: true,  // pour tracer les zones
        marker: true,   // pour définir le point d'eau
        polyline: false,
        circle: false,
        rectangle: false
      }
    });
    map.addControl(drawControl);

    // Stockage des données dessinées
    var zones = [];
    var pointEau = null;

    map.on(L.Draw.Event.CREATED, function (e) {
      var type = e.layerType,
          layer = e.layer;
      drawnItems.addLayer(layer);

      if (type === 'polygon') {
        // Sauvegarder la zone : récupération des coordonnées du polygone
        var latlngs = layer.getLatLngs()[0].map(function(ll) {
          return { lat: ll.lat, lng: ll.lng };
        });
        zones.push({ coords: latlngs });
      } else if (type === 'marker') {
        // Considérer le marker comme le point d'eau (un seul autorisé)
        pointEau = layer.getLatLng();
      }
    });

    // Géocodage de l'adresse via Nominatim (optionnel, pour recentrer la carte)
    document.getElementById('geocodeBtn').addEventListener('click', function() {
      var address = document.getElementById('addressInput').value;
      if (!address) {
        alert("Veuillez entrer une adresse.");
        return;
      }
      fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address))
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            var lat = parseFloat(data[0].lat);
            var lon = parseFloat(data[0].lon);
            map.setView([lat, lon], 18);
          } else {
            alert("Adresse non trouvée.");
          }
        })
        .catch(err => {
          console.error(err);
          alert("Erreur lors de la géocodification.");
        });
    });

    // Envoyer les données au backend pour générer le plan d'irrigation
    document.getElementById('submitBtn').addEventListener('click', function() {
      var address = document.getElementById('addressInput').value;
      var pression = parseFloat(document.getElementById('pressionInput').value);
      var zoom = map.getZoom(); // Récupération du niveau de zoom pour gérer l'échelle

      if (!address || zones.length === 0 || !pointEau) {
        alert("Veuillez saisir l'adresse, tracer au moins une zone et placer un point d'eau.");
        return;
      }

      var payload = {
        address: address,
        zones: zones,
        point_eau: { lat: pointEau.lat, lng: pointEau.lng },
        pression: pression,
        zoom: zoom
      };

      fetch('/generate_plan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        console.log("Plan généré :", data);
        alert("Plan généré. Consultez la console pour voir les surfaces et autres infos.");
        // Ici, vous pouvez afficher le plan généré (par exemple, tracer les tuyaux, arroseurs, etc.)
      })
      .catch(err => {
        console.error(err);
        alert("Erreur lors de la génération du plan.");
      });
    });
  </script>
</body>
</html>
